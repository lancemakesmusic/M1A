rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is admin
    function isAdmin() {
      return request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.email == 'admin@merkabaent.com';
    }
    
    // Users collection
    match /users/{userId} {
      // Allow users to read their own profile
      allow read: if request.auth != null && request.auth.uid == userId;
      // Allow reading public profiles (non-private)
      allow read: if resource.data.private == false;
      // Allow reading if user is following (for private profiles)
      allow read: if request.auth != null && 
        exists(/databases/$(database)/documents/followers/$(request.auth.uid + '_' + userId));
      // Admin can read any user profile
      allow read: if isAdmin();
      // Users can only write their own profile
      allow write: if request.auth != null && request.auth.uid == userId;
      // Admin can write any user profile
      allow write: if isAdmin();
    }
    
    // Posts collection
    match /posts/{postId} {
      allow read: if true; // Public read
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update, delete: if request.auth != null && (resource.data.userId == request.auth.uid || isAdmin());
    }
    
    // Wallet transactions
    match /walletTransactions/{transactionId} {
      // Users can only read their own transactions
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      // Admin can read all transactions
      allow read: if isAdmin();
      
      // Users can create their own transactions
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.userId &&
        request.resource.data.timestamp != null &&
        request.resource.data.amount != null;
      // Admin can create transactions for any user (for store credit adjustments)
      allow create: if isAdmin() &&
        request.resource.data.userId != null &&
        request.resource.data.amount != null;
      
      // Only allow status updates (for webhooks and user actions)
      allow update: if request.auth != null && 
        (request.auth.uid == resource.data.userId || isAdmin()) &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'updatedAt', 'error']);
      
      // Prevent transaction deletion
      allow delete: if false;
    }
    
    // Services, events, etc.
    match /services/{serviceId} {
      allow read: if true; // Public read
      allow create: if request.auth != null || isAdmin(); // Authenticated users or admin can create
      allow update, delete: if request.auth != null || isAdmin(); // Authenticated users or admin can update/delete
    }
    
    match /events/{eventId} {
      allow read: if true; // Public read
      allow create: if request.auth != null || isAdmin(); // Authenticated users or admin can create
      allow update, delete: if request.auth != null || isAdmin(); // Authenticated users or admin can update/delete
    }
    
    // Public events collection
    match /publicEvents/{eventId} {
      allow read: if true; // Public read
      allow create: if request.auth != null || isAdmin(); // Authenticated users or admin can create
      allow update, delete: if request.auth != null || isAdmin(); // Authenticated users or admin can update/delete
    }
    
    // Conversations
    match /conversations/{conversationId} {
      function isAuthenticated() {
        return request.auth != null;
      }

      function participantsList(data) {
        return data.participants is list &&
          data.participants.size() >= 2 &&
          data.participants.size() <= 50;
      }

      function isConversationParticipant() {
        return isAuthenticated() &&
          resource != null &&
          request.auth.uid in resource.data.participants;
      }

      allow read: if isConversationParticipant();

      allow create: if isAuthenticated() &&
        participantsList(request.resource.data) &&
        request.auth.uid in request.resource.data.participants;

      allow update, delete: if isConversationParticipant();
    }
    
    // Messages (subcollection)
    match /conversations/{conversationId}/messages/{messageId} {
      function conversationDoc() {
        return get(/databases/$(database)/documents/conversations/$(conversationId));
      }

      function canAccessConversation() {
        return request.auth != null &&
          conversationDoc().data.keys().hasAll(['participants']) &&
          request.auth.uid in conversationDoc().data.participants;
      }

      allow read: if canAccessConversation();
      
      allow create: if canAccessConversation() &&
        request.resource.data.senderId == request.auth.uid &&
        ('createdAt' in request.resource.data) &&
        request.resource.data.keys().hasOnly(['text', 'senderId', 'createdAt']);
    }
    
    // Service orders
    match /serviceOrders/{orderId} {
      // Users can read their own orders
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      // Admin can read all orders
      allow read: if isAdmin();
      // Users can create their own orders
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      // Users can update their own orders
      allow update: if request.auth != null && request.auth.uid == resource.data.userId;
      // Admin can update any order
      allow update: if isAdmin();
    }
    
    // Bar orders
    match /barOrders/{orderId} {
      // Users can read their own orders
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      // Admin can read all orders
      allow read: if isAdmin();
      // Users can create their own orders
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      // Users can update their own orders
      allow update: if request.auth != null && request.auth.uid == resource.data.userId;
      // Admin can update any order
      allow update: if isAdmin();
    }
    
    // RSVPs
    match /rsvps/{rsvpId} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }
    
    // Event bookings (for dashboard stats)
    match /eventBookings/{bookingId} {
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.userId;
    }
    
    // Event orders (for Stripe payments)
    match /eventOrders/{orderId} {
      // Users can read their own orders
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      // Admin can read all orders
      allow read: if isAdmin();
      // Users can create their own orders
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      // Users can update their own orders
      allow update: if request.auth != null && request.auth.uid == resource.data.userId;
      // Admin can update any order
      allow update: if isAdmin();
    }
    
    // Wallets
    match /wallets/{walletId} {
      // Users can only read their own wallet
      allow read: if request.auth != null && request.auth.uid == walletId;
      // Admin can read all wallets
      allow read: if isAdmin();
      
      // Users can create their own wallet (only with 0 balance)
      allow create: if request.auth != null && 
        request.auth.uid == walletId &&
        request.resource.data.balance == 0;
      // Admin can create wallets for any user (for store credit purposes)
      // Admins can set any balance when creating wallets
      allow create: if isAdmin() &&
        request.resource.data.userId == walletId;
      
      // Users can only update their own wallet
      // Balance updates must include transaction ID for audit
      // Only allow updates to balance, updatedAt, and lastTransactionId
      allow update: if request.auth != null && 
        (request.auth.uid == walletId || isAdmin()) &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['balance', 'updatedAt', 'lastTransactionId']) &&
        (request.resource.data.lastTransactionId != null || isAdmin());
      
      // Prevent wallet deletion
      allow delete: if false;
    }
    
    // Payment methods
    match /paymentMethods/{paymentMethodId} {
      allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
    }
    
    // Followers collection (for follower counts)
    // Allow aggregation queries (getCountFromServer) for follower counts
    match /followers/{followerId} {
      allow read: if true; // Public read for follower counts and aggregation queries
      allow create: if request.auth != null && 
        request.resource.data.followerId == request.auth.uid;
      allow delete: if request.auth != null && 
        resource.data.followerId == request.auth.uid;
    }
    
    // Blocks collection
    match /blocks/{blockId} {
      allow read: if request.auth != null && 
        (resource.data.blockerId == request.auth.uid || resource.data.blockedId == request.auth.uid);
      allow create: if request.auth != null && 
        request.resource.data.blockerId == request.auth.uid;
      allow delete: if request.auth != null && 
        resource.data.blockerId == request.auth.uid;
    }
    
    // Mutes collection
    match /mutes/{muteId} {
      allow read: if request.auth != null && 
        resource.data.muterId == request.auth.uid;
      allow create: if request.auth != null && 
        request.resource.data.muterId == request.auth.uid;
      allow delete: if request.auth != null && 
        resource.data.muterId == request.auth.uid;
    }
    
    // Reports collection
    match /reports/{reportId} {
      allow create: if request.auth != null && 
        request.resource.data.reporterId == request.auth.uid;
      allow read: if isAdmin(); // Only admins can read reports
    }
    
    // Profile views collection
    match /profileViews/{viewId} {
      allow create: if request.auth != null && 
        request.resource.data.viewerId == request.auth.uid;
      allow read: if request.auth != null && 
        (resource.data.viewerId == request.auth.uid || resource.data.viewedUserId == request.auth.uid);
    }
    
    // Notifications collection
    match /notifications/{notificationId} {
      allow read: if request.auth != null && 
        resource.data.userId == request.auth.uid;
      allow read: if isAdmin(); // Admin can read all notifications
      allow create: if request.auth != null || isAdmin(); // System or admin can create notifications
      allow update: if request.auth != null && 
        (resource.data.userId == request.auth.uid || isAdmin());
    }
    
    // Allow collection group queries for followers (needed for aggregation)
    match /{path=**}/followers/{followerId} {
      allow read: if true;
      allow write: if request.auth != null;
    }
    
    // Test/debug collection (for testing)
    match /test/{document=**} {
      allow read, write: if request.auth != null;
    }
  }
}
