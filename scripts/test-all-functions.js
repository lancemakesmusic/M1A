/**
 * Comprehensive App Functionality Test Script
 * Tests all backend APIs and verifies app functionality
 */

import fetch from 'node-fetch';

const API_BASE_URL = 'http://172.20.10.3:8001';
const TEST_USER_ID = 'test_user_' + Date.now();

// Test results
const results = {
  passed: 0,
  failed: 0,
  tests: []
};

function logTest(name, passed, message = '') {
  results.tests.push({ name, passed, message });
  if (passed) {
    results.passed++;
    console.log(`‚úÖ ${name}`);
  } else {
    results.failed++;
    console.log(`‚ùå ${name}: ${message}`);
  }
}

async function testBackendHealth() {
  try {
    const response = await fetch(`${API_BASE_URL}/api/health`);
    const data = await response.json();
    logTest('Backend Health Check', response.ok && data.status === 'healthy', 
      response.ok ? '' : `Status: ${data.status}`);
    return response.ok;
  } catch (error) {
    logTest('Backend Health Check', false, error.message);
    return false;
  }
}

async function testContentGeneration() {
  try {
    const response = await fetch(`${API_BASE_URL}/api/generate-content`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        prompt: 'Test content generation',
        content_type: 'post',
        platform: 'instagram',
        brand_voice: 'professional',
        target_audience: 'general'
      })
    });
    const data = await response.json();
    logTest('Content Generation', 
      (data.success || data.status === 'success') && data.content,
      data.message || 'No content generated');
  } catch (error) {
    logTest('Content Generation', false, error.message);
  }
}

async function testSchedulePost() {
  try {
    const scheduledTime = new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString();
    const response = await fetch(`${API_BASE_URL}/api/schedule-post`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        uid: TEST_USER_ID,
        content: 'Test scheduled post',
        imageUrl: '',
        platforms: { instagram: true, facebook: false },
        scheduledTime: scheduledTime,
        status: 'scheduled',
        autoGenerated: false,
        createdAt: new Date().toISOString()
      })
    });
    const data = await response.json();
    logTest('Schedule Post', 
      data.success || data.status === 'success',
      data.message || 'Failed to schedule');
  } catch (error) {
    logTest('Schedule Post', false, error.message);
  }
}

async function testGetScheduledPosts() {
  try {
    const response = await fetch(`${API_BASE_URL}/api/scheduled-posts`);
    const data = await response.json();
    logTest('Get Scheduled Posts', 
      data.success || data.status === 'success',
      data.message || 'Failed to retrieve posts');
  } catch (error) {
    logTest('Get Scheduled Posts', false, error.message);
  }
}

async function testGetMediaLibrary() {
  try {
    const response = await fetch(`${API_BASE_URL}/api/media-library`);
    const data = await response.json();
    logTest('Get Media Library', 
      data.success || data.status === 'success',
      data.message || 'Failed to retrieve media');
  } catch (error) {
    logTest('Get Media Library', false, error.message);
  }
}

async function testAutoPosterStatus() {
  try {
    const response = await fetch(`${API_BASE_URL}/api/auto-poster-status`);
    const data = await response.json();
    logTest('Auto Poster Status', 
      data.success || data.status === 'success',
      data.message || 'Failed to get status');
  } catch (error) {
    logTest('Auto Poster Status', false, error.message);
  }
}

async function testToggleAutoPoster() {
  try {
    const response = await fetch(`${API_BASE_URL}/api/toggle-auto-poster`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ enabled: true })
    });
    const data = await response.json();
    logTest('Toggle Auto Poster', 
      data.success || data.status === 'success',
      data.message || 'Failed to toggle');
  } catch (error) {
    logTest('Toggle Auto Poster', false, error.message);
  }
}

async function testServiceBooking() {
  try {
    const response = await fetch(`${API_BASE_URL}/api/service-booking`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        userId: TEST_USER_ID,
        serviceId: 'test_service_1',
        serviceName: 'Test Service',
        serviceDate: new Date().toISOString(),
        serviceTime: '10:00 AM',
        quantity: 1,
        contactName: 'Test User',
        contactEmail: 'test@example.com',
        totalCost: 100.00,
        subtotal: 90.00,
        tax: 8.00,
        serviceFee: 2.00
      })
    });
    const data = await response.json();
    logTest('Service Booking', 
      data.success || data.status === 'success',
      data.message || 'Failed to book service');
  } catch (error) {
    logTest('Service Booking', false, error.message);
  }
}

async function testBarOrder() {
  try {
    const response = await fetch(`${API_BASE_URL}/api/bar-order`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        userId: TEST_USER_ID,
        items: [
          { id: '1', name: 'Test Drink', price: 10.00, quantity: 2 }
        ],
        subtotal: 20.00,
        tax: 1.60,
        serviceFee: 2.00,
        total: 23.60,
        category: 'Mixed Drinks'
      })
    });
    const data = await response.json();
    logTest('Bar Order', 
      data.success || data.status === 'success',
      data.message || 'Failed to create order');
  } catch (error) {
    logTest('Bar Order', false, error.message);
  }
}

async function testDashboardStats() {
  try {
    const response = await fetch(`${API_BASE_URL}/api/dashboard/stats`);
    const data = await response.json();
    logTest('Dashboard Stats', 
      response.ok && (data.totalBookings !== undefined || data.totalRevenue !== undefined),
      'Stats not returned');
  } catch (error) {
    logTest('Dashboard Stats', false, error.message);
  }
}

async function runAllTests() {
  console.log('üß™ Starting Comprehensive App Functionality Tests...\n');
  console.log(`üì° Testing Backend: ${API_BASE_URL}\n`);
  
  // Test backend connectivity first
  const backendHealthy = await testBackendHealth();
  
  if (!backendHealthy) {
    console.log('\n‚ùå Backend is not accessible. Please start the backend server first.');
    console.log('   Run: cd autoposter-backend && python start_backend.py\n');
    return;
  }
  
  console.log('\nüìã Testing Auto-Poster Features...');
  await testContentGeneration();
  await testSchedulePost();
  await testGetScheduledPosts();
  await testGetMediaLibrary();
  await testAutoPosterStatus();
  await testToggleAutoPoster();
  
  console.log('\nüìã Testing Booking Features...');
  await testServiceBooking();
  await testBarOrder();
  
  console.log('\nüìã Testing Dashboard...');
  await testDashboardStats();
  
  // Summary
  console.log('\n' + '='.repeat(50));
  console.log('üìä TEST RESULTS SUMMARY');
  console.log('='.repeat(50));
  console.log(`‚úÖ Passed: ${results.passed}`);
  console.log(`‚ùå Failed: ${results.failed}`);
  console.log(`üìà Success Rate: ${((results.passed / (results.passed + results.failed)) * 100).toFixed(1)}%`);
  console.log('\n');
  
  if (results.failed === 0) {
    console.log('üéâ All backend tests passed!');
    console.log('\nüí° Next: Test the mobile app manually using COMPREHENSIVE_TESTING_CHECKLIST.md');
  } else {
    console.log('‚ö†Ô∏è  Some tests failed. Please check the errors above.');
    console.log('\nüí° Fix backend issues, then test the mobile app manually.');
  }
  
  console.log('\n');
}

// Run tests
runAllTests().catch(console.error);

